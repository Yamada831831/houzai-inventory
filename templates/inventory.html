<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>åœ¨åº«ä¸€è¦§</title>
  <style>
    body {
      font-family: "Noto Sans JP", "Meiryo", sans-serif;
      background-color: #f4f6f8;
      margin: 20px;
      color: #333;
    }
    h1 {
      font-size: 24px;
      margin-bottom: 20px;
    }
    .tab {
      display: inline-block;
      margin-right: 10px;
      cursor: pointer;
      font-weight: bold;
      padding: 6px 12px;
      background-color: #e0e6eb;
      border-radius: 6px;
    }
    .tab:hover {
      background-color: #d0d8de;
    }
    .active {
      background-color: #007bff;
      color: #fff;
    }
    .hidden {
      display: none;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 10px;
      background-color: #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    th {
      background-color: #f0f3f5;
      text-align: left;
      padding: 12px;
      font-size: 14px;
    }
    td {
      padding: 12px;
      border-top: 1px solid #e0e6eb;
      font-size: 14px;
    }
    .low-stock {
      color: red;
      font-weight: bold;
    }
    tr:hover {
      background-color: #f9fbfc;
    }
    button {
      padding: 6px 12px;
      margin: 2px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background-color: #0056b3;
    }
  </style>
</head>
<body>
<!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ -->
<nav style="background-color: #f5f5f5; padding: 10px 20px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); font-family: 'Noto Sans JP', 'Meiryo', sans-serif; display: flex; flex-direction: row; flex-wrap: wrap; gap: 10px;">
  <a href="/inventory" style="text-decoration: none; color: #333; font-weight: bold;">ğŸ“¦ åœ¨åº«ä¸€è¦§</a>
  <a href="/work_schedule" style="text-decoration: none; color: #333; font-weight: bold;">ğŸ“ ä½œæ¥­äºˆå®š</a>
  <a href="/shipment" style="text-decoration: none; color: #333; font-weight: bold;">ğŸšš å‡ºè·äºˆå®š</a>
  <a href="/dispatch" style="text-decoration: none; color: #333; font-weight: bold;">ğŸ“¤ è”µå‡ºã—</a>
  <a href="/arrival" style="text-decoration: none; color: #333; font-weight: bold;">ğŸ“¥ åŒ…æå…¥è·</a>
  <a href="/stock_adjust" style="text-decoration: none; color: #333; font-weight: bold;">ğŸ§® æ£šå¸ã—</a>
  <a href="/setting_logs" style="text-decoration: none; color: #333; font-weight: bold;">âš™ï¸ è¨­å®šãƒ»ãƒ­ã‚°</a>
</nav>


  <h1>åœ¨åº«ä¸€è¦§</h1>

<!-- ä¸Šæ®µï¼šå¤§ã‚«ãƒ†ã‚´ãƒªã‚¿ãƒ– -->
<div>
  <span class="tab active" onclick="showTab('packaging')">åŒ…æ</span>
  <span class="tab" onclick="showTab('semi')">åŠå®Œæˆå“</span>
  <span class="tab" onclick="showTab('finished')">å®Œæˆå“</span>
</div>

<!-- åŒ…æã‚«ãƒ†ã‚´ãƒªï¼ˆè¢‹ï¼è¡¨ã‚·ãƒ¼ãƒ«ï¼è£ã‚·ãƒ¼ãƒ«ï¼‰ -->
<div id="packaging" class="tab-content">
  <div style="margin-top: 10px;">
    <span class="tab active" onclick="showMaterialTab('è¢‹')">è¢‹</span>
    <span class="tab" onclick="showMaterialTab('è¡¨ã‚·ãƒ¼ãƒ«')">è¡¨ã‚·ãƒ¼ãƒ«</span>
    <span class="tab" onclick="showMaterialTab('è£ã‚·ãƒ¼ãƒ«')">è£ã‚·ãƒ¼ãƒ«</span>
  </div>

  <div id="material-wrapper" style="margin-top: 10px;">
    <div id="material-è¢‹" class="material-content">
      <table>
        <thead><tr><th>å“å</th><th>åœ¨åº«</th><th>æ“ä½œ</th></tr></thead>
        <tbody id="è¢‹-body"></tbody>
      </table>
    </div>
    <div id="material-è¡¨ã‚·ãƒ¼ãƒ«" class="material-content hidden">
      <table>
        <thead><tr><th>å“å</th><th>åœ¨åº«</th><th>æ“ä½œ</th></tr></thead>
        <tbody id="è¡¨ã‚·ãƒ¼ãƒ«-body"></tbody>
      </table>
    </div>
    <div id="material-è£ã‚·ãƒ¼ãƒ«" class="material-content hidden">
      <table>
        <thead><tr><th>å“å</th><th>åœ¨åº«</th><th>æ“ä½œ</th></tr></thead>
        <tbody id="è£ã‚·ãƒ¼ãƒ«-body"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- åŠå®Œæˆå“ -->
<div id="semi" class="tab-content hidden">
  <table>
    <thead><tr><th>å“å</th><th>åœ¨åº«</th><th>æ“ä½œ</th></tr></thead>
    <tbody id="semi-body"></tbody>
  </table>
</div>

<!-- å®Œæˆå“ -->
<div id="finished" class="tab-content hidden">
  <table>
    <thead><tr><th>å“å</th><th>åœ¨åº«</th><th>æ“ä½œ</th></tr></thead>
    <tbody id="finished-body"></tbody>
  </table>
</div>


<script>
 function showTab(tabId) {
  // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„åˆ‡ã‚Šæ›¿ãˆ
  document.querySelectorAll(".tab-content").forEach(div => div.classList.add("hidden"));
  document.getElementById(tabId).classList.remove("hidden");

  // ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã® active åˆ‡ã‚Šæ›¿ãˆ
  const tabs = document.querySelectorAll("div > .tab"); // ã™ã¹ã¦ã® .tab ã‚’å–å¾—
  tabs.forEach(tab => tab.classList.remove("active"));
  
  // ä»Šã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚¿ãƒ–ã‚’ active ã«ï¼ˆâ†ã“ã‚Œé‡è¦ï¼ï¼‰
  event.target.classList.add("active");

  if (tabId === 'packaging') {
    showMaterialTab('è¢‹');
  }
}

function showMaterialTab(type) {
  // åŒ…æã‚«ãƒ†ã‚´ãƒªåˆ‡æ›¿
  document.querySelectorAll("#material-wrapper .material-content").forEach(div => div.classList.add("hidden"));
  document.getElementById("material-" + type).classList.remove("hidden");

  // åŒ…æã‚«ãƒ†ã‚´ãƒªãƒœã‚¿ãƒ³ã® .active åˆ‡æ›¿
  const materialTabs = document.querySelectorAll("#packaging > div > .tab");
  materialTabs.forEach(tab => tab.classList.remove("active"));
  event.target.classList.add("active");
}



  // åœ¨åº«èª­ã¿è¾¼ã¿ï¼ˆAPIï¼‰
  async function loadInventory() {
    const res = await fetch("/api/inventory");
    const data = await res.json();
    renderInventory(data);
  }

  // ã‚«ãƒ†ã‚´ãƒªã”ã¨ã«åˆ†ã‘ã¦è¡¨ç¤º
  function renderInventory(data) {
  const semiBody = document.getElementById("semi-body");
  const finishedBody = document.getElementById("finished-body");
  const materialBodies = {
    "è¢‹": document.getElementById("è¢‹-body"),
    "è¡¨ã‚·ãƒ¼ãƒ«": document.getElementById("è¡¨ã‚·ãƒ¼ãƒ«-body"),
    "è£ã‚·ãƒ¼ãƒ«": document.getElementById("è£ã‚·ãƒ¼ãƒ«-body")
  };

  semiBody.innerHTML = "";
  finishedBody.innerHTML = "";
  Object.values(materialBodies).forEach(tb => tb.innerHTML = "");

  data.forEach(item => {
    if (item.category === "semi") {
      if (item.stock > 0) {
        const row = createRow(item);
        semiBody.appendChild(row);
      }
    } else if (item.category === "finished") {
      if (item.stock > 0) {
        const row = createRow(item);
        finishedBody.appendChild(row);
      }
    } else if (item.category === "material") {
      const row = createRow(item);
      materialBodies[item.type].appendChild(row);
    }
  });
}

function createRow(item) {
  const row = document.createElement("tr");
  const low = item.stock <= item.threshold ? ' style="background-color:#ffebee;"' : '';

  // å¿…ãšitem.idã‚’ä½¿ã†ï¼ï¼
  const qtyInput = `<input type="number" id="qty-${item.id}" value="1" min="1" style="width: 60px; margin-right: 4px;">`;

  let buttons = `
    ${qtyInput}
    <button data-id="${item.id}" data-category="${item.category}" onclick="adjustStock(this, -1)">ä½¿ç”¨</button>
    <button data-id="${item.id}" data-category="${item.category}" onclick="adjustStock(this, 1)">æˆ»ã—</button>
  `;

if (item.category === "semi" || item.category === "finished") {
    buttons += `<button onclick="registerWork(${item.id}, '${item.category}')">ä½œæ¥­äºˆå®šã«è¿½åŠ </button>`;
  }

  row.innerHTML = `
    <td>${item.name}</td>
    <td${low}>${item.stock}</td>
    <td>${buttons}</td>
  `;
  return row;
}



  // ä½¿ç”¨ãƒ»æˆ»ã—
async function adjustStock(button, direction) {
  const id = button.getAttribute("data-id");
  const category = button.getAttribute("data-category");

  const tr = button.closest("tr");
  const qtyInput = tr.querySelector("input[type='number']");
  const changeAmount = qtyInput ? parseInt(qtyInput.value) || 1 : 1;

  // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã§ã‚³ãƒ¡ãƒ³ãƒˆå…¥åŠ›ã•ã›ã‚‹ï¼
  const userComment = prompt("ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š", "");
  if (userComment === null) {
    // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚ŒãŸã‚‰ä¸­æ–­
    return;
  }

  console.log("é€ä¿¡ãƒ‡ãƒ¼ã‚¿:", {
    id: id,
    category: category,
    change: direction * changeAmount,
    comment: userComment
  });

  try {
    const response = await fetch("/api/inventory/adjust", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        id: id,
        category: category,
        change: direction * changeAmount,
        comment: userComment
      }),
    });

    const data = await response.json();
    console.log("ã‚µãƒ¼ãƒãƒ¼å¿œç­”:", data.message || data.error);

    if (response.ok) {
      loadInventory();
    } else {
      alert(data.error || "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼");
    }
  } catch (error) {
    console.error("é€šä¿¡ã‚¨ãƒ©ãƒ¼:", error);
    alert("ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“ã§ã—ãŸã€‚");
  }
}


  // ä½œæ¥­ç™»éŒ²ï¼ˆä½œæ¥­äºˆå®šã«è¿½åŠ ï¼‰
  async function registerWork(id, category) {
    const quantity = prompt("ä½œæ¥­æšæ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š");
    if (!quantity || isNaN(quantity)) {
      alert("æ­£ã—ã„æšæ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
      return;
    }

    const res = await fetch("/api/schedules", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        product_type: category,
        product_id: id,
        quantity: parseInt(quantity),
        comment: "åœ¨åº«ç”»é¢ã‹ã‚‰ç™»éŒ²"
      })
    });

    if (res.ok) {
      alert("ä½œæ¥­äºˆå®šã«ç™»éŒ²ã—ã¾ã—ãŸï¼");
    } else {
      alert("ä½œæ¥­ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ");
    }
  }

  window.onload = loadInventory;
</script>


</body>
</html>
