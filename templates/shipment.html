<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>å‡ºè·äºˆå®šã‚¤ãƒ³ãƒãƒ¼ãƒˆ</title>
  <style>
    body {
      font-family: "Noto Sans JP", "Meiryo", sans-serif;
      background: #f4f6f8;
      margin: 20px;
    }
    h1 {
      font-size: 22px;
    }
    input, select {
      padding: 6px;
      margin: 4px;
    }
    button {
      padding: 6px 12px;
      margin-top: 10px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
    }
    button:disabled {
      background-color: #ccc;
    }
    table {
      width: 100%;
      margin-top: 20px;
      border-collapse: collapse;
      background: #fff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    th, td {
      padding: 8px;
      border: 1px solid #ccc;
      font-size: 14px;
    }
    .error-row {
      background-color: #ffe0e0;
    }
  </style>
</head>
<body>
<!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ -->
<nav style="background-color: #f5f5f5; padding: 10px 20px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); font-family: 'Noto Sans JP', 'Meiryo', sans-serif; display: flex; flex-direction: column; gap: 10px;">
  <!-- 1åˆ—ç›® -->
  <div>
    <a href="/inventory" style="margin-right: 15px; text-decoration: none; color: #333; font-weight: bold;">ğŸ“¦ åœ¨åº«ä¸€è¦§</a>
    <a href="/work_schedule" style="margin-right: 15px; text-decoration: none; color: #333; font-weight: bold;">ğŸ“ ä½œæ¥­äºˆå®š</a>
    <a href="/shipment" style="margin-right: 15px; text-decoration: none; color: #333; font-weight: bold;">ğŸšš å‡ºè·äºˆå®š</a>
    <a href="/dispatch" style="margin-right: 15px; text-decoration: none; color: #333; font-weight: bold;">ğŸ“¤ è”µå‡ºã—</a>
    <a href="/arrival" style="margin-right: 15px; text-decoration: none; color: #333; font-weight: bold;">ğŸ“¥ åŒ…æå…¥è·</a>
    <a href="/stock_adjust" style="text-decoration: none; color: #333; font-weight: bold;">ğŸ§® æ£šå¸ã—</a>
  </div>

  <!-- 2åˆ—ç›® -->
  <div>
    <a href="/master_material" style="margin-right: 15px; text-decoration: none; color: #333; font-weight: bold;">ğŸ· åŒ…æãƒã‚¹ã‚¿</a>
    <a href="/master_semi" style="margin-right: 15px; text-decoration: none; color: #333; font-weight: bold;">ğŸ§© åŠå®Œæˆå“ãƒã‚¹ã‚¿</a>
    <a href="/master_finished" style="margin-right: 15px; text-decoration: none; color: #333; font-weight: bold;">ğŸ¯ å®Œæˆå“ãƒã‚¹ã‚¿</a>
    <a href="/master_worker" style="text-decoration: none; color: #333; font-weight: bold;">ğŸ‘¤ ä½œæ¥­è€…ãƒã‚¹ã‚¿</a>
  </div>

  <!-- 3åˆ—ç›® -->
  <div>
    <a href="/work_log" style="margin-right: 15px; text-decoration: none; color: #333; font-weight: bold;">ğŸ“‚ ä½œæ¥­ãƒ­ã‚°</a>
    <a href="/stock_adjust_logs" style="margin-right: 15px; text-decoration: none; color: #333; font-weight: bold;">ğŸ§® æ£šå¸ã—å±¥æ­´</a>
    <a href="/arrival_logs" style="text-decoration: none; color: #333; font-weight: bold;">ğŸ“¥ åŒ…æå…¥è·å±¥æ­´</a>
  </div>
</nav>

  <h1>å‡ºè·äºˆå®šã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h1>

  <!-- CSVèª­ã¿è¾¼ã¿ -->
  <input type="file" id="csvFile" accept=".csv" />
  <button onclick="importCSV()">CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>

  <h2>æ‰‹å‹•è¿½åŠ </h2>
  <div>
    <input type="text" id="manualName" placeholder="å•†å“å" required />
    <input type="text" id="manualDest" placeholder="å‡ºè·å…ˆ" required />
    <input type="text" id="manualSize" placeholder="è¦æ ¼" required />
    <input type="text" id="manualOrigin" placeholder="ç”£åœ°" required />
    <input type="number" id="manualPack" placeholder="å…¥æ•°" style="width: 60px;" />
    <input type="text" id="manualJan" placeholder="JANä¸‹6æ¡" style="width: 100px;" />
    <input type="number" id="mon" placeholder="æœˆ" style="width: 50px;" />
    <input type="number" id="tue" placeholder="ç«" style="width: 50px;" />
    <input type="number" id="wed" placeholder="æ°´" style="width: 50px;" />
    <input type="number" id="thu" placeholder="æœ¨" style="width: 50px;" />
    <input type="number" id="fri" placeholder="é‡‘" style="width: 50px;" />
    <input type="number" id="sat" placeholder="åœŸ" style="width: 50px;" />
    <input type="number" id="sun" placeholder="æ—¥" style="width: 50px;" />
    <button onclick="addManual()">è¿½åŠ </button>
  </div>

  <table>
    <thead>
      <tr>
        <th>å•†å“å</th><th>å‡ºè·å…ˆ</th><th>è¦æ ¼</th><th>ç”£åœ°</th><th>å…¥æ•°</th><th>JAN</th>
        <th>æœˆ</th><th>ç«</th><th>æ°´</th><th>æœ¨</th><th>é‡‘</th><th>åœŸ</th><th>æ—¥</th>
        <th>å®Œæˆå“åï¼ˆãƒã‚¹ã‚¿ï¼‰</th>
      </tr>
    </thead>
    <tbody id="shipment-body"></tbody>
  </table>

  <button id="registerBtn" onclick="registerShipment()" disabled>ç™»éŒ²</button>

  <script>
    let shipmentData = [];

    function importCSV() {
      const file = document.getElementById("csvFile").files[0];
      if (!file) return alert("CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚");

      const reader = new FileReader();
      reader.onload = function (e) {
        const lines = e.target.result.split("\n").filter(l => l.trim() !== "");
        const headers = lines[0].split(",");
        shipmentData = lines.slice(1).map(line => {
          const cols = line.split(",");
          const obj = {};
          headers.forEach((h, i) => {
            obj[h.trim()] = isNaN(cols[i]) ? cols[i]?.trim() : parseInt(cols[i]);
          });
          return obj;
        });
        validateAndRender();
      };
      reader.readAsText(file, "utf-8");
    }

    function addManual() {
  const name = document.getElementById("manualName").value.trim();
  const dest = document.getElementById("manualDest").value.trim();
  const size = document.getElementById("manualSize").value.trim();
  const origin = document.getElementById("manualOrigin").value.trim();
  const pack = parseInt(document.getElementById("manualPack").value) || 0;

  if (!name || !dest || !size || !origin || pack <= 0) {
    alert("å•†å“åãƒ»å‡ºè·å…ˆãƒ»è¦æ ¼ãƒ»ç”£åœ°ãƒ»å…¥æ•°ã¯å¿…é ˆã§ã™");
    return;
  }

  const item = {
    "å•†å“å": name,
    "å‡ºè·å…ˆ": dest,
    "è¦æ ¼": size,
    "ç”£åœ°": origin,
    "å…¥æ•°": pack,
    "JANã‚³ãƒ¼ãƒ‰": document.getElementById("manualJan").value.trim(), // â† ç©ºæ¬„OK
    "æœˆ": parseInt(document.getElementById("mon").value) || 0,
    "ç«": parseInt(document.getElementById("tue").value) || 0,
    "æ°´": parseInt(document.getElementById("wed").value) || 0,
    "æœ¨": parseInt(document.getElementById("thu").value) || 0,
    "é‡‘": parseInt(document.getElementById("fri").value) || 0,
    "åœŸ": parseInt(document.getElementById("sat").value) || 0,
    "æ—¥": parseInt(document.getElementById("sun").value) || 0
  };

  shipmentData.push(item);
  validateAndRender();
}


    function validateAndRender() {
  const tbody = document.getElementById("shipment-body");
  tbody.innerHTML = "";
  let pending = shipmentData.length;

  shipmentData.forEach((item) => {
    const tr = document.createElement("tr");

    const requestBody = {
      product_name: item["å•†å“å"],
      destination: item["å‡ºè·å…ˆ"],
      size: item["è¦æ ¼"],
      origin: item["ç”£åœ°"]
    };

    fetch("/api/finished_products/lookup", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(requestBody)
    })
    .then(res => res.json())
    .then(data => {
      const matchName = data.name || "ï¼ˆæœªç™»éŒ²ï¼‰";
      const finishedId = data.id || null;

      if (!finishedId) tr.classList.add("error-row");

      // è¡¨ç¤ºã‚«ãƒ©ãƒ ä¸€è¦§
      const keys = ["å•†å“å", "å‡ºè·å…ˆ", "è¦æ ¼", "ç”£åœ°", "å…¥æ•°", "JANã‚³ãƒ¼ãƒ‰", "æœˆ", "ç«", "æ°´", "æœ¨", "é‡‘", "åœŸ", "æ—¥"];
      keys.forEach(k => {
        const td = document.createElement("td");
        td.textContent = item[k] || "";
        tr.appendChild(td);
      });

      // ç…§åˆã•ã‚ŒãŸå®Œæˆå“åï¼ˆã¾ãŸã¯æœªç™»éŒ²ï¼‰ã‚’æœ€å¾Œã«è¿½åŠ 
      const tdName = document.createElement("td");
      tdName.textContent = matchName;
      tr.appendChild(tdName);

      // å®Œæˆå“IDã¨è¡¨ç¤ºåã‚’ item ã«è¿½åŠ 
      item.finished_id = finishedId;
      item.match_name = matchName;

      tbody.appendChild(tr);

      pending--;
      if (pending === 0) {
        const anyError = document.querySelector(".error-row");
        document.getElementById("registerBtn").disabled = !!anyError;
      }
    })
    .catch(err => {
      console.error("ç…§åˆã‚¨ãƒ©ãƒ¼:", err);
      tr.classList.add("error-row");
      tbody.appendChild(tr);
      pending--;
      document.getElementById("registerBtn").disabled = true;
    });
  });
}


    function registerShipment() {
      fetch("/api/shipments/register", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ shipments: shipmentData })
      })
      .then(res => res.json())
      .then(data => {
        alert(data.message || "ä½œæ¥­äºˆå®šã«ç™»éŒ²ã—ã¾ã—ãŸï¼");
      });
    }
  </script>
</body>
</html>
