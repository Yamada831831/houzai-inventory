<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ä½œæ¥­äºˆå®šä¸€è¦§</title>
  <style>
    body {
      font-family: "Noto Sans JP", "Meiryo", sans-serif;
      background-color: #f4f6f8;
      margin: 20px;
      color: #333;
    }
    h1 {
      font-size: 24px;
      margin-bottom: 20px;
    }
    .form-group {
      margin-bottom: 10px;
      display: block;
    }
    form {
      background-color: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-bottom: 6px;
      font-weight: bold;
    }
    select, input {
      width: 100%;
      padding: 8px;
      margin-top: 4px;
      margin-bottom: 12px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    button {
      padding: 8px 16px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background-color: #0056b3;
    }
    .delete-btn {
      background-color: #dc3545;
      margin-left: 8px;
    }
    .delete-btn:hover {
      background-color: #a71d2a;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background-color: #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    th {
      background-color: #f0f3f5;
      text-align: left;
      padding: 12px;
      font-size: 14px;
    }
    td {
      padding: 12px;
      border-top: 1px solid #e0e6eb;
      font-size: 14px;
    }
    .pending { background-color: #f9f9f9; }
    .requested { background-color: #fff8dc; }
    .completed { background-color: #e0ffe0; }
    tr:hover { background-color: #f9fbfc; }
  </style>
</head>
<body>
<nav style="background-color: #f5f5f5; padding: 10px 20px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); font-family: 'Noto Sans JP', 'Meiryo', sans-serif; display: flex; flex-direction: row; flex-wrap: wrap; gap: 10px;">
  <a href="/inventory" style="text-decoration: none; color: #333; font-weight: bold;">ğŸ“¦ åœ¨åº«ä¸€è¦§</a>
  <a href="/work_schedule" style="text-decoration: none; color: #333; font-weight: bold;">ğŸ“ ä½œæ¥­äºˆå®š</a>
  <a href="/shipment" style="text-decoration: none; color: #333; font-weight: bold;">ğŸšš å‡ºè·äºˆå®š</a>
  <a href="/dispatch" style="text-decoration: none; color: #333; font-weight: bold;">ğŸ“¤ è”µå‡ºã—</a>
  <a href="/arrival" style="text-decoration: none; color: #333; font-weight: bold;">ğŸ“¥ åŒ…æå…¥è·</a>
  <a href="/stock_adjust" style="text-decoration: none; color: #333; font-weight: bold;">ğŸ§® æ£šå¸ã—</a>
  <a href="/setting_logs" style="text-decoration: none; color: #333; font-weight: bold;">âš™ï¸ è¨­å®šãƒ»ãƒ­ã‚°</a>
</nav>

  <h1>ä½œæ¥­äºˆå®šä¸€è¦§</h1>

  <form id="work-form">
    <div class="form-group">
      <label>ã‚¿ã‚¤ãƒ—ï¼š
        <select id="type">
          <option value="finished">å®Œæˆå“</option>
          <option value="semi">åŠå®Œæˆå“</option>
        </select>
      </label>
    </div>
    <div class="form-group">
      <label>è£½å“åï¼š
        <select id="product" required></select>
      </label>
    </div>
    <div class="form-group">
      <label>ä½œæ¥­è€…ï¼ˆä»»æ„ï¼‰ï¼š
        <select id="worker">
          <option value="">ï¼ˆæœªé¸æŠï¼‰</option>
        </select>
      </label>
    </div>
    <div class="form-group">
      <label>æšæ•°ï¼š
        <input type="number" id="quantity" required>
      </label>
    </div>
    <div class="form-group">
      <label>è£ã‚·ãƒ¼ãƒ«JANä¸‹6æ¡ï¼š
        <input type="text" id="jan_code" pattern="\d{6}" placeholder="ä¾‹ï¼š123456">
      </label>
    </div>
    <div class="form-group">
      <label>ã‚³ãƒ¡ãƒ³ãƒˆï¼š
        <input type="text" id="comment">
      </label>
    </div>
    <div class="form-group">
      <button type="submit">äºˆå®šã‚’è¿½åŠ </button>
    </div>
  </form>

<button onclick="selectAll()" style="margin: 10px;">â˜‘ï¸ å…¨ã¦é¸æŠ</button>
<button onclick="selectNone()" style="margin: 10px;">â é¸æŠè§£é™¤</button>
<button onclick="bulkUpdate()" style="margin: 10px;">ğŸ›  é¸æŠæ›´æ–°</button>
<button onclick="bulkPrint()" style="margin: 10px;">ğŸ–¨ é¸æŠå°åˆ·</button>
<button onclick="bulkComplete()" style="margin: 10px;">ğŸ é¸æŠå®Œäº†</button>
<button onclick="bulkDelete()" style="margin: 10px;">ğŸ—‘ é¸æŠå‰Šé™¤</button>

  <table>
    <thead>
      <tr>
        <th>é¸æŠ</th>
        <th onclick="sortTable('id')">ä¾é ¼No.</th>
        <th onclick="sortTable('product_type')">ã‚¿ã‚¤ãƒ—</th>
        <th onclick="sortTable('product_name')">è£½å“å</th>
        <th onclick="sortTable('worker_name')">ä½œæ¥­è€…</th>
        <th onclick="sortTable('quantity')">æšæ•°</th>
        <th onclick="sortTable('jan_code')">JANä¸‹6æ¡</th>
        <th onclick="sortTable('status')">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
        <th onclick="sortTable('comment')">ã‚³ãƒ¡ãƒ³ãƒˆ</th>
        <th>æ“ä½œ</th>
      </tr>
    </thead>
    <tbody id="schedule-list"></tbody>
  </table>

  <script>
    const typeSelect = document.getElementById("type");
    const productSelect = document.getElementById("product");
    const list = document.getElementById("schedule-list");
    let checkedIds = new Set();

    async function fetchProducts() {
      const [semi, finished] = await Promise.all([
        fetch("/api/semi_products").then(res => res.json()),
        fetch("/api/finished_products").then(res => res.json())
      ]);
      return { semi, finished };
    }

    let products = {};
    async function populateProducts() {
      products = await fetchProducts();
      updateProductOptions();
    }
ã€€ã€€
ã€€ã€€let workers = [];
async function loadWorkers() {
  const res = await fetch("/api/workers");
  workers = await res.json();

  // ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ ã® <select id="worker"> ã«ã‚»ãƒƒãƒˆ
  const workerSelect = document.getElementById("worker");
  if (workerSelect) {
    workerSelect.innerHTML = '<option value="">ï¼ˆæœªé¸æŠï¼‰</option>' +
      workers.map(w => `<option value="${w.id}">${w.name}</option>`).join("");
  }
}

let currentSortColumn = null;
let currentSortOrder = 'asc'; // æœ€åˆã¯æ˜‡é †

function sortTable(column) {
  if (currentSortColumn === column) {
    // åŒã˜åˆ—ã‚’æŠ¼ã—ãŸã‚‰é †ç•ªã²ã£ãã‚Šè¿”ã™
    currentSortOrder = currentSortOrder === 'asc' ? 'desc' : 'asc';
  } else {
    // é•ã†åˆ—æŠ¼ã—ãŸã‚‰ã€æ–°ã—ã„åˆ—ã§æ˜‡é †ã«
    currentSortColumn = column;
    currentSortOrder = 'asc';
  }
  loadSchedules(); // ã‚½ãƒ¼ãƒˆã—ã¦å†èª­ã¿è¾¼ã¿ï¼
}

async function loadSchedules() {
  const res = await fetch("/api/schedules");
  let data = await res.json();

  if (currentSortColumn) {
    data.sort((a, b) => {
      let valA = a[currentSortColumn] || "";
      let valB = b[currentSortColumn] || "";

      // æ•°å­—ã£ã½ã‹ã£ãŸã‚‰æ•°å­—æ¯”è¼ƒã™ã‚‹
      if (!isNaN(valA) && !isNaN(valB)) {
        valA = Number(valA);
        valB = Number(valB);
      }

      if (valA < valB) return currentSortOrder === 'asc' ? -1 : 1;
      if (valA > valB) return currentSortOrder === 'asc' ? 1 : -1;
      return 0;
    });
  }

  list.innerHTML = "";
  data.forEach(addRow);
}


function updateSchedule(id, silent = false) {
  const qty = document.getElementById(`qty-${id}`).value;
  const jan = document.getElementById(`jan-${id}`).value;
  const worker = document.getElementById(`worker-${id}`).value || null;

  return fetch(`/api/schedules/${id}`, {
    method: "PATCH",
    headers: {
      "Content-Type": "application/json",
    },
    body: JSON.stringify({
      quantity: parseInt(qty),
      jan_code: jan,
      worker_id: worker ? parseInt(worker) : null
    }),
  })
    .then((res) => res.json())
    .then((data) => {
      if (!silent) {
        alert(data.message || "æ›´æ–°ã—ã¾ã—ãŸï¼");
      }
      return data;
    })
    .catch((err) => console.error("æ›´æ–°ã‚¨ãƒ©ãƒ¼:", err));
}



    function updateProductOptions() {
      const type = typeSelect.value;
      const options = products[type];
      productSelect.innerHTML = "";
      options.forEach(p => {
        const option = document.createElement("option");
        option.value = p.id;
        option.textContent = type === "semi" ? `${p.label}ï¼‹${p.bag}` : `${p.destination} ${p.product_name} ${p.size}ï¼ˆ${p.origin}ï¼‰`;
        productSelect.appendChild(option);
      });
    }

    typeSelect.addEventListener("change", updateProductOptions);

    

    function addRow(item) {
      const row = document.createElement("tr");
      const className = item.status === "ä¾é ¼æ¸ˆ" ? "requested" : (item.status === "å®Œäº†" ? "completed" : "pending");
      row.className = className;

      row.innerHTML = `
        <td><input type="checkbox" class="schedule-checkbox" data-id="${item.id}" ${checkedIds.has(String(item.id)) ? "checked" : ""}></td>
        <td>${item.id}</td>
        <td>${item.product_type === 'semi' ? 'åŠå®Œæˆå“' : 'å®Œæˆå“'}</td>
        <td>${item.product_name || 'ID:' + item.product_id}</td>
        <td>
  <select id="worker-${item.id}" class="input-worker">
    <option value="">ï¼ˆæœªé¸æŠï¼‰</option>
    ${workers.map(w => `
      <option value="${w.id}" ${w.id === item.worker_id ? "selected" : ""}>
        ${w.name}
      </option>`).join("")}
  </select>
</td>
        <td><input type="number" value="${item.quantity}" id="qty-${item.id}" class="input-qty" style="width: 60px;"></td>
        <td><input type="text" value="${item.jan_code || ''}" id="jan-${item.id}" class="input-jan" style="width: 80px;"></td>
        <td>${item.status}</td>
        <td>${item.comment || ""}</td>
        <td>
          <button onclick="updateSchedule(${item.id})" class="btn btn-update">æ›´æ–°</button>
          <button onclick="printSchedule(${item.id})" class="btn btn-print">å°åˆ·</button>
          <button onclick="completeSchedule(${item.id})" class="btn btn-complete">å®Œäº†</button>
          <button onclick="deleteSchedule(${item.id})" class="btn btn-delete">å‰Šé™¤</button>
        </td>
      `;
      list.appendChild(row);
    }

    async function completeSchedule(id) {
      if (!confirm("å®Œäº†ã—ã¦åœ¨åº«ã‚’æ›´æ–°ã—ã¾ã™ã‹ï¼Ÿ")) return;
      await fetch(`/api/schedules/${id}/complete`, { method: "PATCH" });
      loadSchedules();
    }

    async function updateStatus(id, status) {
  const res = await fetch(`/api/schedules/${id}`, {
    method: "PATCH",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ status })
  });
  const data = await res.json();
  return data;  // â† ã“ã“ã§è¿”ã™ã ã‘ã«ã™ã‚‹
}


async function printSchedule(id) {
  await updateStatus(id, "ä¾é ¼æ¸ˆ");
  loadSchedules();

  // å°åˆ·ãƒšãƒ¼ã‚¸ã‚’æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã
  window.open(`/print_request?id=${id}`, "_blank");
}

function selectAll() {
  document.querySelectorAll(".schedule-checkbox").forEach(cb => {
    cb.checked = true;
    checkedIds.add(cb.dataset.id);
  });
}

function selectNone() {
  document.querySelectorAll(".schedule-checkbox").forEach(cb => {
    cb.checked = false;
    checkedIds.delete(cb.dataset.id);
  });
}


async function bulkUpdate() {
  const checked = document.querySelectorAll(".schedule-checkbox:checked");
  if (checked.length === 0) {
    alert("æ›´æ–°ã™ã‚‹ä½œæ¥­äºˆå®šã‚’é¸ã‚“ã§ãã ã•ã„ï¼");
    return;
  }
  if (!confirm(`é¸æŠã•ã‚ŒãŸ ${checked.length} ä»¶ã®ä½œæ¥­äºˆå®šã‚’ã¾ã¨ã‚ã¦æ›´æ–°ã—ã¾ã™ã‹ï¼Ÿ`)) return;

  for (const checkbox of checked) {
    const id = checkbox.getAttribute("data-id");
    await updateSchedule(id, true); // ã“ã“ã§ã€Œã‚µã‚¤ãƒ¬ãƒ³ãƒˆãƒ¢ãƒ¼ãƒ‰ã€ã§æ›´æ–°
  }

  alert(`${checked.length} ä»¶ã®ä½œæ¥­äºˆå®šã‚’æ›´æ–°ã—ã¾ã—ãŸï¼`);
  loadSchedules();
}

async function bulkComplete() {
  const checked = document.querySelectorAll(".schedule-checkbox:checked");
  if (checked.length === 0) {
    alert("å®Œäº†ã™ã‚‹ä½œæ¥­äºˆå®šã‚’é¸ã‚“ã§ãã ã•ã„ï¼");
    return;
  }
  if (!confirm(`é¸æŠã•ã‚ŒãŸ ${checked.length} ä»¶ã®ä½œæ¥­äºˆå®šã‚’ã¾ã¨ã‚ã¦å®Œäº†ã—ã¾ã™ã‹ï¼Ÿ`)) return;

  for (const checkbox of checked) {
    const id = checkbox.getAttribute("data-id");
    await completeSchedule(id);
  }

  alert(`${checked.length} ä»¶ã®ä½œæ¥­äºˆå®šã‚’å®Œäº†ã—ã¾ã—ãŸï¼`);
  loadSchedules();
}

async function bulkDelete() {
  const checked = document.querySelectorAll(".schedule-checkbox:checked");
  if (checked.length === 0) {
    alert("å‰Šé™¤ã™ã‚‹ä½œæ¥­äºˆå®šã‚’é¸ã‚“ã§ãã ã•ã„ï¼");
    return;
  }
  if (!confirm(`é¸æŠã•ã‚ŒãŸ ${checked.length} ä»¶ã®ä½œæ¥­äºˆå®šã‚’ã¾ã¨ã‚ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;

  for (const checkbox of checked) {
    const id = checkbox.getAttribute("data-id");
    await deleteSchedule(id);
  }

  alert(`${checked.length} ä»¶ã®ä½œæ¥­äºˆå®šã‚’å‰Šé™¤ã—ã¾ã—ãŸï¼`);
  loadSchedules();
}


async function bulkPrint() {
  const checked = document.querySelectorAll(".schedule-checkbox:checked");
  if (checked.length === 0) {
    alert("å°åˆ·ã™ã‚‹ä½œæ¥­äºˆå®šã‚’é¸ã‚“ã§ãã ã•ã„ï¼");
    return;
  }
  if (!confirm(`é¸æŠã•ã‚ŒãŸ ${checked.length} ä»¶ã®ä½œæ¥­äºˆå®šã‚’ã¾ã¨ã‚ã¦å°åˆ·ã—ã¾ã™ã‹ï¼Ÿ`)) return;

  for (const checkbox of checked) {
    const id = checkbox.getAttribute("data-id");
    await updateStatus(id, "ä¾é ¼æ¸ˆ");  // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ã€Œä¾é ¼æ¸ˆã€ã«å¤‰æ›´
    window.open(`/print_request?id=${id}`, "_blank"); // ä¾é ¼æ›¸ã‚’æ–°ã‚¿ãƒ–ã§é–‹ã
  }

  loadSchedules(); // ä½œæ¥­äºˆå®šãƒªãƒ­ãƒ¼ãƒ‰
}



    async function deleteSchedule(id) {
      if (!confirm("ã“ã®ä½œæ¥­äºˆå®šã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
      await fetch(`/api/schedules/${id}`, { method: "DELETE" });
      loadSchedules();
    }

    document.getElementById("work-form").addEventListener("submit", async e => {
  e.preventDefault();
  const data = {
    product_type: typeSelect.value,
    product_id: parseInt(document.getElementById("product").value),
    worker_id: null,
    quantity: parseInt(document.getElementById("quantity").value),
    jan_code: document.getElementById("jan_code").value,
    comment: document.getElementById("comment").value,
    status: "äºˆå®š"  // â†ã“ã‚Œã‚’è¿½åŠ ï¼
  };
  await fetch("/api/schedules", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(data)
  });
  e.target.reset();
  updateProductOptions();
  loadSchedules();
});


    window.onload = async () => {
      await populateProducts();
      await loadWorkers();
      await loadSchedules();
    };

document.addEventListener("change", (e) => {
  if (e.target.classList.contains("schedule-checkbox")) {
    const id = e.target.dataset.id;
    if (e.target.checked) {
      checkedIds.add(id);
    } else {
      checkedIds.delete(id);
    }
  }
});

  </script>
</body>
</html>
