<!DOCTYPE html>

<html lang="ja">
<head>
<meta charset="utf-8"/>
<title>å®Œæˆå“ãƒã‚¹ã‚¿ç®¡ç†</title>
<style>
    body {
      font-family: "Noto Sans JP", "Meiryo", sans-serif;
      background-color: #f4f6f8;
      margin: 20px;
    }
    h1 {
      font-size: 22px;
      margin-bottom: 20px;
    }
    input, select {
      padding: 6px;
      margin: 4px;
    }
    button {
      padding: 6px 12px;
      margin-left: 4px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background-color: #0056b3;
    }
    .delete-btn {
      background-color: #dc3545;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background-color: #fff;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
    }
    th, td {
      padding: 10px;
      border: 1px solid #ddd;
      font-size: 14px;
      text-align: left;
    }
    .inactive {
      background-color: #f0f0f0;
      color: #aaa;
    }
    th[data-key] { cursor: pointer; user-select: none; }
    th.sort-asc::after  { content: " â–²"; }
    th.sort-desc::after { content: " â–¼"; }
  </style>
</head>
<body>
<!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ -->
<nav style="background-color: #f5f5f5; padding: 10px 20px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); font-family: 'Noto Sans JP', 'Meiryo', sans-serif; display: flex; flex-direction: row; flex-wrap: wrap; gap: 10px;">
  <a href="/inventory" style="text-decoration: none; color: #333; font-weight: bold;">ğŸ“¦ åœ¨åº«ä¸€è¦§</a>
  <a href="/work_schedule" style="text-decoration: none; color: #333; font-weight: bold;">ğŸ“ ä½œæ¥­äºˆå®š</a>
  <a href="/shipment" style="text-decoration: none; color: #333; font-weight: bold;">ğŸšš å‡ºè·äºˆå®š</a>
  <a href="/dispatch" style="text-decoration: none; color: #333; font-weight: bold;">ğŸ“¤ è”µå‡ºã—</a>
  <a href="/arrival" style="text-decoration: none; color: #333; font-weight: bold;">ğŸ“¥ åŒ…æå…¥è·</a>
  <a href="/stock_adjust" style="text-decoration: none; color: #333; font-weight: bold;">ğŸ§® æ£šå¸ã—</a>
  <a href="/setting_logs" style="text-decoration: none; color: #333; font-weight: bold;">âš™ï¸ è¨­å®šãƒ»ãƒ­ã‚°</a>
</nav>


<h1>å®Œæˆå“ãƒã‚¹ã‚¿ç®¡ç†</h1>
<!-- æ–°è¦è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ  -->
<form onsubmit="addProduct(); return false;">
<input id="dest" placeholder="å‡ºè·å…ˆ" required="" type="text"/>
<input id="name" placeholder="å•†å“å" required="" type="text"/>
<input id="size" placeholder="è¦æ ¼" required="" type="text"/>
<input id="origin" placeholder="ç”£åœ°" required="" type="text"/>
<select id="seal" required>
  <option value="">è£ã‚·ãƒ¼ãƒ«ã‚’é¸æŠ</option>
</select>

<select id="semiId" required>
  <option value="">åŠå®Œæˆå“ã‚’é¸æŠ</option>
</select>
<button type="submit">è¿½åŠ </button>
</form>
<!-- å®Œæˆå“ãƒã‚¹ã‚¿ä¸€è¦§ -->
<table>
<thead>
  <tr>
    <th data-key="destination"  data-type="string">å‡ºè·å…ˆ</th>
    <th data-key="product_name" data-type="string">å•†å“å</th>
    <th data-key="size"         data-type="string">è¦æ ¼</th>
    <th data-key="origin"       data-type="string">ç”£åœ°</th>
    <th data-key="seal_name"    data-type="string">è£ã‚·ãƒ¼ãƒ«å</th>
    <th data-key="label_bag"    data-type="string">åŠå®Œæˆå“</th>
    <th data-key="created_at"   data-type="date">ç™»éŒ²æ—¥</th>
    <th>æ“ä½œ</th>
  </tr>
</thead>
<tbody id="master-list"></tbody>
</table>
<script>
  // å®Œæˆå“ç™»éŒ²
  function addProduct() {
    const destination = document.getElementById("dest").value;
    const name = document.getElementById("name").value;
    const size = document.getElementById("size").value;
    const origin = document.getElementById("origin").value;
    const sealId = parseInt(document.getElementById("seal").value);
    const semiId = parseInt(document.getElementById("semiId").value);

    fetch("/api/finished_products", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        destination: destination,
        product_name: name,
        size: size,
        origin: origin,
        seal_material_id: sealId,
        semi_product_id: semiId
      })
    })
    .then(res => res.json())
    .then(data => {
      console.log("ç™»éŒ²å®Œäº†:", data);
      location.reload();
    });

    return false;
  }

  // åˆæœŸãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰
  function loadMaterialsAndSemi() {
    fetch("/api/materials")
      .then(res => res.json())
      .then(data => {
        const sealSelect = document.getElementById("seal");
        data.filter(m => m.type === "è£ã‚·ãƒ¼ãƒ«").forEach(m => {
          const opt = document.createElement("option");
          opt.value = m.id;
          opt.textContent = m.name;
          sealSelect.appendChild(opt);
        });
      });

    fetch("/api/semi_products")
      .then(res => res.json())
      .then(data => {
        const semiSelect = document.getElementById("semiId");
        data.forEach(s => {
          const opt = document.createElement("option");
          opt.value = s.id;
          opt.textContent = `${s.label} + ${s.bag}`;
          semiSelect.appendChild(opt);
        });
      });
  }

  // â–¼ ä¸¦ã¹æ›¿ãˆç”¨ã®çŠ¶æ…‹
  let finishedProducts = [];
  const sortState = { key: 'created_at', type: 'date', dir: 'desc' };

  // â–¼ æ¯”è¼ƒé–¢æ•°
  const collator = new Intl.Collator('ja', { numeric: true, sensitivity: 'base' });
  function getVal(p, key, type) {
    let v = p[key];
    if (key === 'label_bag') v = `${p.label_name} + ${p.bag_name}`;
    if (type === 'number') return Number(v ?? 0);
    if (type === 'date')   return v ? new Date(v).getTime() : 0;
    return (v ?? '').toString();
  }
  function applySort(arr) {
    const { key, type, dir } = sortState;
    const mul = dir === 'asc' ? 1 : -1;
    return [...arr].sort((a,b) => {
      const va = getVal(a, key, type);
      const vb = getVal(b, key, type);
      if (type === 'string') return collator.compare(va, vb) * mul;
      return (va < vb ? -1 : va > vb ? 1 : 0) * mul;
    });
  }

  // â–¼ ãƒ†ãƒ¼ãƒ–ãƒ«å†æç”»
  function renderTable() {
    const list = document.getElementById("master-list");
    list.innerHTML = "";
    const data = applySort(finishedProducts);

    data.forEach(p => {
      const row = document.createElement("tr");
      if (!p.is_active) row.classList.add("inactive");
      const labelBag = `${p.label_name} + ${p.bag_name}`;
      row.innerHTML = `
        <td>${p.destination ?? ''}</td>
        <td>${p.product_name ?? ''}</td>
        <td>${p.size ?? ''}</td>
        <td>${p.origin ?? ''}</td>
        <td>${p.seal_name ?? ''}</td>
        <td>${labelBag}</td>
        <td>${p.created_at ?? ''}</td>
        <td>
          <button onclick="toggleProduct(${p.id})">${p.is_active ? 'ç„¡åŠ¹åŒ–' : 'æœ‰åŠ¹åŒ–'}</button>
          <button onclick="deleteProduct(${p.id})" class="delete-btn">å‰Šé™¤</button>
        </td>
      `;
      list.appendChild(row);
    });

    // ãƒ˜ãƒƒãƒ€ã®â–²â–¼è¡¨ç¤ºæ›´æ–°
    document.querySelectorAll('thead th').forEach(th => th.classList.remove('sort-asc','sort-desc'));
    const activeTh = document.querySelector(`thead th[data-key="${sortState.key}"]`);
    if (activeTh) activeTh.classList.add(sortState.dir === 'asc' ? 'sort-asc' : 'sort-desc');
  }

  // â–¼ ã‚¯ãƒªãƒƒã‚¯ã§ã‚½ãƒ¼ãƒˆåˆ‡ã‚Šæ›¿ãˆ
  function bindHeaderSort() {
    document.querySelectorAll('thead th[data-key]').forEach(th => {
      th.addEventListener('click', () => {
        const key = th.dataset.key;
        const type = th.dataset.type || 'string';
        if (sortState.key === key) {
          sortState.dir = (sortState.dir === 'asc') ? 'desc' : 'asc';
        } else {
          sortState.key = key;
          sortState.type = type;
          sortState.dir = 'asc';
        }
        renderTable();
      });
    });
  }

  // â–¼ å®Œæˆå“ä¸€è¦§ãƒ­ãƒ¼ãƒ‰ï¼ˆé…åˆ—ã‚’ä¿æŒã—ã¦ã‹ã‚‰æç”»ï¼‰
  function loadFinishedProducts() {
    fetch("/api/finished_products")
      .then(res => res.json())
      .then(data => {
        finishedProducts = data;
        renderTable();
      });
  }

  function toggleProduct(id) {
    fetch(`/api/finished_products/${id}/toggle`, { method: "PATCH" })
      .then(res => res.json())
      .then(() => loadFinishedProducts());
  }

  function deleteProduct(id) {
    const confirmDelete = confirm("ã“ã®å®Œæˆå“ãƒã‚¹ã‚¿ã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ");
    if (!confirmDelete) return;

    fetch(`/api/finished_products/${id}`, { method: "DELETE" })
      .then(res => res.json())
      .then(() => loadFinishedProducts());
  }

  window.onload = () => {
    loadMaterialsAndSemi();
    bindHeaderSort();        // â† è¿½åŠ 
    loadFinishedProducts();
  };
</script>
</body>
</html>
