<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>æ£šå¸ã—</title>
  <style>
    body {
      font-family: "Noto Sans JP", "Meiryo", sans-serif;
      background-color: #f9f9f9;
      margin: 20px;
    }
    h1 { font-size: 22px; margin-bottom: 20px; }
    .tab { margin-right: 10px; cursor: pointer; padding: 6px 12px; background-color: #eee; border-radius: 6px; }
    .tab.active { background-color: #007bff; color: white; }
    .hidden { display: none; }

    table {
      width: 100%;
      border-collapse: collapse;
      background-color: white;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      font-size: 14px;
      text-align: center;
    }
    input[type="number"], input[type="text"] {
      width: 80px;
      padding: 4px;
    }
    .adjust-btn {
      background-color: #28a745;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
    }
  </style>
</head>
<body>
<!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ -->
<nav style="background-color: #f5f5f5; padding: 10px 20px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); font-family: 'Noto Sans JP', 'Meiryo', sans-serif; display: flex; flex-direction: row; flex-wrap: wrap; gap: 10px;">
  <a href="/inventory" style="text-decoration: none; color: #333; font-weight: bold;">ğŸ“¦ åœ¨åº«ä¸€è¦§</a>
  <a href="/work_schedule" style="text-decoration: none; color: #333; font-weight: bold;">ğŸ“ ä½œæ¥­äºˆå®š</a>
  <a href="/shipment" style="text-decoration: none; color: #333; font-weight: bold;">ğŸšš å‡ºè·äºˆå®š</a>
  <a href="/dispatch" style="text-decoration: none; color: #333; font-weight: bold;">ğŸ“¤ è”µå‡ºã—</a>
  <a href="/arrival" style="text-decoration: none; color: #333; font-weight: bold;">ğŸ“¥ åŒ…æå…¥è·</a>
  <a href="/stock_adjust" style="text-decoration: none; color: #333; font-weight: bold;">ğŸ§® æ£šå¸ã—</a>
  <a href="/setting_logs" style="text-decoration: none; color: #333; font-weight: bold;">âš™ï¸ è¨­å®šãƒ»ãƒ­ã‚°</a>
</nav>

<h1>æ£šå¸ã—ç”»é¢</h1>

<!-- ã‚«ãƒ†ã‚´ãƒªåˆ‡æ›¿ -->
<div style="margin-bottom: 15px;">
  <span class="tab active" onclick="showTab('material', this)">åŒ…æ</span>
  <span class="tab" onclick="showTab('semi', this)">åŠå®Œæˆå“</span>
  <span class="tab" onclick="showTab('finished', this)">å®Œæˆå“</span>
</div>

<!-- åŒ…æã‚«ãƒ†ã‚´ãƒªåˆ‡æ›¿ -->
<div id="material-subtabs" style="margin-bottom: 10px;">
  <span class="tab active" onclick="showMaterialTab('è¢‹', this)">è¢‹</span>
  <span class="tab" onclick="showMaterialTab('è¡¨ã‚·ãƒ¼ãƒ«', this)">è¡¨ã‚·ãƒ¼ãƒ«</span>
  <span class="tab" onclick="showMaterialTab('è£ã‚·ãƒ¼ãƒ«', this)">è£ã‚·ãƒ¼ãƒ«</span>
</div>

<!-- åŒ…æ -->
<div id="material" class="tab-content">
  <div id="material-è¢‹">
    <h3>è¢‹</h3>
    <table><thead><tr><th>å“å</th><th>ç¾åœ¨åº«</th><th>å®Ÿæ•°</th><th>å·®åˆ†</th><th>ã‚³ãƒ¡ãƒ³ãƒˆ</th><th>æ“ä½œ</th></tr></thead><tbody id="è¢‹-body"></tbody></table>
  </div>
  <div id="material-è¡¨ã‚·ãƒ¼ãƒ«" class="material-content hidden">
    <h3>è¡¨ã‚·ãƒ¼ãƒ«</h3>
    <table><thead><tr><th>å“å</th><th>ç¾åœ¨åº«</th><th>å®Ÿæ•°</th><th>å·®åˆ†</th><th>ã‚³ãƒ¡ãƒ³ãƒˆ</th><th>æ“ä½œ</th></tr></thead><tbody id="è¡¨ã‚·ãƒ¼ãƒ«-body"></tbody></table>
  </div>
  <div id="material-è£ã‚·ãƒ¼ãƒ«" class="material-content hidden">
    <h3>è£ã‚·ãƒ¼ãƒ«</h3>
    <table><thead><tr><th>å“å</th><th>ç¾åœ¨åº«</th><th>å®Ÿæ•°</th><th>å·®åˆ†</th><th>ã‚³ãƒ¡ãƒ³ãƒˆ</th><th>æ“ä½œ</th></tr></thead><tbody id="è£ã‚·ãƒ¼ãƒ«-body"></tbody></table>
  </div>
</div>

<!-- åŠå®Œæˆå“ -->
<div id="semi" class="tab-content hidden">
  <h3>åŠå®Œæˆå“</h3>
  <table><thead><tr><th>å“å</th><th>ç¾åœ¨åº«</th><th>å®Ÿæ•°</th><th>å·®åˆ†</th><th>ã‚³ãƒ¡ãƒ³ãƒˆ</th><th>æ“ä½œ</th></tr></thead><tbody id="semi-body"></tbody></table>
</div>

<!-- å®Œæˆå“ -->
<div id="finished" class="tab-content hidden">
  <h3>å®Œæˆå“</h3>
  <table><thead><tr><th>å“å</th><th>ç¾åœ¨åº«</th><th>å®Ÿæ•°</th><th>å·®åˆ†</th><th>ã‚³ãƒ¡ãƒ³ãƒˆ</th><th>æ“ä½œ</th></tr></thead><tbody id="finished-body"></tbody></table>
</div>

<script>
function showTab(type, el) {
  document.querySelectorAll('.tab-content').forEach(e => e.classList.add('hidden'));
  document.getElementById(type).classList.remove('hidden');
  document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
  el.classList.add('active');

  // åŒ…æã‚«ãƒ†ã‚´ãƒªã‚¿ãƒ–ã®è¡¨ç¤º/éè¡¨ç¤ºåˆ¶å¾¡
  const subtab = document.getElementById("material-subtabs");
  if (type === "material") {
    subtab.style.display = "block";
  } else {
    subtab.style.display = "none";
  }
}


function showMaterialTab(subtype, el) {
  document.querySelectorAll('[id^="material-"]').forEach(e => e.classList.add('hidden'));
  document.getElementById(`material-${subtype}`).classList.remove('hidden');
  document.querySelectorAll('#material-subtabs .tab').forEach(tab => tab.classList.remove('active'));
  el.classList.add('active');
}

function loadInventory() {
  fetch("/api/inventory")
    .then(res => res.json())
    .then(data => {
      ["è¢‹", "è¡¨ã‚·ãƒ¼ãƒ«", "è£ã‚·ãƒ¼ãƒ«"].forEach(k => document.getElementById(`${k}-body`).innerHTML = "");
      document.getElementById("semi-body").innerHTML = "";
      document.getElementById("finished-body").innerHTML = "";

      data.forEach(item => {
        if (item.category === "material") {
          const row = renderRow(item, item.name, item.stock, item.category);
          document.getElementById(`${item.type}-body`).appendChild(row);
        } else {
          const row = renderRow(item, item.name, item.stock, item.category);
          document.getElementById(`${item.category}-body`).appendChild(row);
        }
      });
    });
}

function renderRow(item, name, stock, category) {
  const id = item.inventory_id; // å®Œæˆå“ã§ã‚‚ inventory.id ã‚’ä½¿ã†ï¼

  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td>${name}</td>
    <td>${stock}</td>
    <td><input type="number" id="actual-${id}" value="${stock}" style="width: 70px;"></td>
    <td id="diff-${id}">0</td>
    <td><input type="text" id="comment-${id}" style="width: 120px;"></td>
    <td>
      <button
        id="adjust-btn-${id}"
        data-inventory-id="${id}"
        onclick="adjust(${id}, '${category}')">
        åæ˜ 
      </button>
    </td>
  `;

  setTimeout(() => {
    document.getElementById(`actual-${id}`).addEventListener("input", () => {
      const newVal = parseInt(document.getElementById(`actual-${id}`).value);
      const diff = newVal - stock;
      document.getElementById(`diff-${id}`).textContent = diff;
    });
  }, 10);

  return tr;
}


function adjust(inventoryId, category) {
  const actual = parseInt(document.getElementById(`actual-${inventoryId}`).value);
  const comment = document.getElementById(`comment-${inventoryId}`).value;

  if (!inventoryId || isNaN(actual)) {
    alert("ã“ã®ã‚¢ã‚¤ãƒ†ãƒ ã¯æ£šå¸ã—ã§ãã¾ã›ã‚“ï¼ˆIDã¾ãŸã¯æ•°é‡ã‚¨ãƒ©ãƒ¼ï¼‰");
    return;
  }

  fetch("/api/stock_adjust", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      id: inventoryId,
      actual_stock: actual,
      comment: comment,
      category: category
    })
  })
    .then(res => res.json())
    .then(data => {
      if (data.error) {
        alert("ã‚¨ãƒ©ãƒ¼: " + data.error);
      } else {
        alert("æ£šå¸ã—å®Œäº†ï¼");
        loadInventory();
      }
    })
    .catch(err => {
      console.error("é€šä¿¡ã‚¨ãƒ©ãƒ¼:", err);
      alert("é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ");
    });
}



window.onload = loadInventory;
</script>
